# Campus Life Simulation

基于图论和最短路径算法的校园生活模拟系统,集成**四维高级拥塞管理策略**。

## ✨ 核心特性

### 🎯 智能路径规划
- **拥塞感知 Dijkstra**: 动态计算路径成本,考虑实时拥塞和队列长度
- **主动重新规划**: 学生智能检测更优路径并自动切换
- **第二短路径**: 提供备选路径,增强系统灵活性

### 🚦 四维拥塞管理
1. **空间分流**: 拥塞感知路径规划,避开高负载区域
2. **时间分流**: 批量释放控制,防止瞬时拥塞
3. **规则调度**: FIFO队列系统,公平管理等待学生
4. **信息引导**: ETA计算、截止时间监控、主动预警

### 📊 实时可视化
- **桥梁队列指示器**: 彩色编码显示拥塞程度 (蓝/黄/橙/红)
- **ETA/截止时间面板**: 实时显示预计到达时间和时间缓冲
- **截止时间警告**: 红色高亮显示有风险的学生
- **平滑动画**: 60 FPS 流畅学生移动


## 项目结构

```
Campus-Life-Simulation/
├── src/
│   ├── campus/                    # 核心模块
│   │   ├── graph.py               # 图结构 + 拥塞感知 Dijkstra
│   │   ├── student.py             # 学生代理 + ETA/重新规划
│   │   ├── schedule.py            # 课程表管理
│   │   ├── simulation.py          # 主模拟引擎
│   │   ├── gui.py                 # Pygame 可视化 + 增强面板
│   │   ├── queue_manager.py       # FIFO 队列管理器 (NEW)
│   │   ├── release_controller.py  # 批量释放控制器 (NEW)
│   │   └── data.py                # 校园地图和课程表数据
│   ├── tests/                     # 测试套件 (24个测试)
│   │   ├── test_graph.py
│   │   ├── test_student.py
│   │   ├── test_simulation.py
│   │   ├── test_bridge_congestion.py
│   │   └── test_congestion_stress.py  # 压力测试 (NEW)
│   └── main.py                    # 启动入口
├── docs/                          # 文档
│   ├── 行动计划.md                # 开发计划
│   ├── 拥塞管理实现报告.md        # 实现总结 (NEW)
│   └── requirement.md             # 需求文档
├── pyproject.toml                 # 项目配置
├── start_simulation.py            # 快速启动脚本
└── run_tests.py                   # 测试运行脚本
```

## 安装

1.  Python 3.11+
2. 创建虚拟环境：
   ```powershell
   python -m venv .venv
   .venv\Scripts\Activate.ps1
   ```

3. 安装项目（开发模式）：
   ```powershell
   pip install -e .
   ```

## 快速开始

### 启动 GUI 模拟

```powershell
# 運行
python start_simulation.py

# 或者
python src/main.py
```


## 待辦事項

根据[行动计划](docs/行动计划.md)：

- [x] 阶段二：底层数据结构实现
  - [x] Building, Path, Graph 类
  - [x] Dijkstra 最短路径算法
  - [x] 单元测试
- [x] 阶段三：学生与课表系统
  - [x] Schedule 类
  - [x] Student 代理
  - [x] 移动逻辑
- [x] 阶段四：模拟引擎
  - [x] SimulationClock 时间系统
  - [x] Simulation 主循环
  - [x] 事件日志
- [x] 阶段五：Pygame GUI
  - [x] 基础窗口和渲染
  - [x] 地图绘制（建筑物和路径）
  - [x] 学生动画
  - [x] 信息面板（时间、统计、事件日志）
  - [x] 交互控制（暂停、加速、切换视图）
- [x] 阶段六：测试与优化
  - [x] 单元测试（19 个全部通过）
  - [x] 代码质量检查
  - [x] 性能优化
- [x] **拥塞管理高级实现** (2024-12-26 完成)
  - [x] **Phase 1**: 基础架构扩展 (队列、ETA、缓冲时间)
  - [x] **Phase 2**: 空间分流策略 (拥塞感知 Dijkstra)
  - [x] **Phase 3**: 规则调度系统 (QueueManager FIFO)
  - [x] **Phase 4**: 时间分流策略 (ReleaseController 批量释放)
  - [x] **Phase 5**: 信息引导系统 (ETA、截止时间、主动重新规划)
  - [x] **Phase 6**: 可视化增强 (队列指示器、ETA面板、警告系统)
  - [x] **Phase 7**: 测试与优化 (5个压力测试, 24/24 全部通过)
- [x] 阶段七：扩展功能（部分完成）
  - [x] 点击学生显示详细信息
  - [x] 高亮显示学生路径
  - [x] 平滑移动动画
  - [x] 统计面板

## 📈 系统性能

### 测试结果 (24/24 ✅)
| 测试类型 | 学生数 | 运行时长 | 状态 |
|---------|-------|---------|------|
| 基础模拟 | 100 | 8小时 | ✅ |
| 队列容量 | 150 | 4小时 | ✅ |
| 准时到达率 | 120 | 6小时 | ✅ |
| 高峰拥塞 | 100 | 1小时 | ✅ |
| 批量释放 | 80 | 2小时 | ✅ |

### 性能指标
- ✅ 平均队列长度: < 5
- ✅ 最大队列长度: < 50
- ✅ 支持 100+ 学生同时模拟
- ✅ GUI 帧率: 60 FPS
- ✅ 无死锁、崩溃现象

## 🎮 GUI 控制

| 按键 | 功能 |
|------|------|
| **SPACE** | 暂停/继续 |
| **↑/↓** | 加速/减速 |
| **P** | 切换路径显示 |
| **C** | 点击学生查看详情 |
| **ESC** | 退出程序 |

### 可视化元素说明
- **桥梁队列圆圈**: 
  - 🔵 蓝色 (< 10): 通畅
  - 🟡 黄色 (10-19): 轻度拥塞
  - 🟠 橙色 (20-39): 中度拥塞
  - 🔴 红色 (≥ 40): 严重拥塞
  
- **学生颜色**:
  - 绿色: 空闲
  - 蓝色: 移动中
  - 橙色: 排队等待
  - 🔴 **红色**: 面临截止时间风险 (NEW)
  
- **信息面板** (点击学生显示):
  - 学生ID、班级、状态、位置
  - **ETA**: 预计到达时间 (NEW)
  - **Deadline**: 截止时间 (NEW)
  - **Time Buffer**: 时间缓冲 (NEW)
  - 当前路径成本、替代路径成本

## 📚 技术文档

详细实现请参考:
- [拥塞管理实现报告](docs/拥塞管理实现报告.md) - 完整技术总结
- [行动计划](docs/行动计划.md) - 开发计划和进度
- [需求文档](docs/requirement.md) - 项目需求
  - [ ] 分離重曡的學生
  - [ ] 增加橋容量判斷
  - [ ] 增加食堂容量判斷

## 技术栈

- Python 3.11+
- 数据结构：图、优先队列
- 算法：Dijkstra 最短路径
- GUI：Pygame 
- 测试：unittest

## 许可证

教学项目
