**目標：** 在學生移動模擬專案中，為「橋樑」實現「容量與擁塞」功能。

**情境設定：**
*   模擬一條東西向的河流，上面有四座橋。
*   中間兩座是「小橋」，承載容量有限。
*   左右兩側的兩座是「大橋」，容量視為無限。

**運作機制：**
*   小橋的通行時間（成本）必須隨著橋上學生人數的增加而變長。
*   大橋的通行時間是固定的，不受人數影響。

**需要開發的學生決策邏輯：**
1.  **動態路徑規劃：** 當學生到達小橋入口，發現橋上非常擁塞（時間成本過高）時，是否應重新計算並尋找新的最短路徑？
2.  **等待 vs. 繞路：** 學生應該可以選擇在橋頭「原地等待」擁塞緩解，還是必須繞道走其他路徑？
3.  **資訊獲取：** 學生如何得知擁塞狀況？我們採用一個真實模型：學生只有在到達橋樑入口（即「橋頭」節點）時，才能知道該橋當前的擁塞程度。

**實作約束：**
*   將每座橋樑模型化為一條**邊 (edge)**。為此，需為每座橋新增兩個節點：「橋頭」和「橋尾」。橋樑本身就是連接這兩個節點的邊。

**請求：**
請提供一個逐步的行動計畫來實現此功能。

***

### **Action Plan to Implement the Feature**

Here is a structured plan to guide the development.

這是一個結構化的開發指南。

**Phase 1: Data Structure Modification (修改資料結構)**

1.  **Update Graph Representation:**
    *   Identify the locations for the four bridges on your map/graph.
    *   For each bridge, remove any direct connection (edge) that crosses the river.
    *   For each bridge, add two new nodes: `Bridgehead_Node` and `Bridge_End_Node` on opposite sides of the river.
    *   Add an edge between `Bridgehead_Node` and `Bridge_End_Node`. This edge represents the bridge itself.
    *   Connect the existing paths to these new bridgehead and bridge-end nodes.

2.  **Add Bridge Attributes:**
    *   Modify the `edge` data structure (or create a `Bridge` class) to include new attributes:
        *   `capacity` (e.g., `max_students_allowed`). For large bridges, set this to a very high number (infinity).
        *   `current_students` (an integer counter or a list of students currently on the bridge).
        *   `base_travel_time` (the time it takes to cross when empty).

**Phase 2: Update Pathfinding Logic (更新路徑規劃邏輯)**

1.  **Implement Dynamic Edge Weight Calculation:**
    *   Modify your shortest path algorithm (e.g., Dijkstra's or A*).
    *   Before the algorithm calculates path costs, it must get the *current* travel time (weight) for each bridge edge.
    *   Create a function `get_bridge_travel_time(bridge)`:
        *   If it's a large bridge, return `base_travel_time`.
        *   If it's a small bridge, calculate the time based on congestion. For example: `travel_time = base_travel_time * (1 + current_students / capacity)`. This formula makes the cost increase with occupancy.

**Phase 3: Implement Student Agent Logic (實作學生決策邏輯)**

1.  **Initial Path Calculation:**
    *   When a student needs to travel to a new destination, they run the shortest path algorithm using the *current* congestion data to get their initial optimal route.

2.  **Decision-Making at Bridge Entrance:**
    *   When a student's state changes to "arrived at a `Bridgehead_Node` of a small bridge":
        *   **Check Congestion:** The student queries the bridge's `current_students`.
        *   **Recalculate Cost:** The student calculates the *actual, real-time* cost to cross.
        *   **Decision Point:**
            *   **If cost is acceptable:** The student proceeds to cross the bridge.
            *   **If cost is too high:** The student must now decide:
                *   **Option A (Reroute):** Temporarily remove the congested bridge edge from their personal view of the graph and run the shortest path algorithm again from their current position (`Bridgehead_Node`) to find an alternative route.
                *   **Option B (Wait):** Change the student's state to "waiting". The student remains at the `Bridgehead_Node` for a set amount of time (e.g., one simulation tick) and then re-evaluates the congestion. Implement a `max_wait_time` to prevent them from waiting forever.

**Phase 4: Simulation Loop Integration (整合到模擬迴圈)**

1.  **Update Student Positions:** In each tick of the simulation, update the positions of students who are moving.
2.  **Manage Bridge Occupancy:**
    *   When a student enters a bridge (moves from `Bridgehead_Node` to the bridge edge), increment `current_students` on that bridge.
    *   When a student exits a bridge (arrives at `Bridge_End_Node`), decrement `current_students`.
3.  **Process Waiting Students:** In each tick, check for any students in the "waiting" state and have them re-evaluate their decision (as described in Phase 3).

**Phase 5: GUI Visualization (更新 GUI 視覺化)**

1.  **Display Congestion:**
    *   Visually represent the bridges.
    *   Change the color of the bridge edge based on its `current_students / capacity` ratio. For example: Green (empty), Yellow (half-full), Red (at or near capacity).
2.  **Show Waiting Students:**
    *   Ensure that students in the "waiting" state are rendered as stationary at the bridgeheads, perhaps with a status indicator (e.g., a "W" icon) next to them.